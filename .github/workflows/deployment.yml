name: Continuous Deployment

on:
  schedule:
    - cron: '0 11 */16 * *'
  push:
    branches:
      - master

jobs:
  deploy:
    name: Continuous Deployment to mariojim.github.io
    runs-on: ubuntu-latest
    container:
      image: mariojim/resume-portfolio:latest
      env:
        REASON: ${{ github.event_name }}
        GRAPHQL_GITHUB_KEY: ${{ secrets.GRAPHQL_GITHUB_KEY }}
        API_KEY_GITHUB_REPO: ${{ secrets.API_KEY_GITHUB_REPO }}

    steps:
      - name: Clone source
        uses: actions/checkout@v2
        with:
          path: 'source'

      - name: Clone website repo
        uses: actions/checkout@v2
        with:
          repository: MarioJim/mariojim.github.io
          path: 'website'
          token: ${{ secrets.API_KEY_GITHUB_REPO }}

      - name: Build website
        run: |
          cd source
          ./build.sh
          if [ "$REASON" == "schedule" ]; then
            echo "COMMIT_MSG=Scheduled for $(date "+%B %-d, %Y")" >> $GITHUB_ENV
          else
            echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          fi
          cd ../website
          git rm -r .
          git restore --staged LICENSE README.md
          mv ../source/portfolio/public/* .
          git add *

      - name: Push website repo
        run: |
          cd website
          git config --global user.name "MarioJim"
          git config --global user.email "mario.emilio.j@gmail.com"
          git commit -m "[CD] $COMMIT_MSG"
          git push
